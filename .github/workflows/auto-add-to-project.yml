name: Auto Add and Sync Project Modules

on:
  push:
    branches:
      - main
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  repository-projects: write

jobs:
  auto-add:
    name: Add new issues to Progress Tracker
    runs-on: ubuntu-latest
    continue-on-error: true  # ‚úÖ even if the add-to-project action throws a harmless error
    steps:
      - name: Add new issue to project board
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/codemedic1424/projects/7
          github-token: ${{ secrets.GITHUB_TOKEN }}

  sync-pathways:
    name: Sync Pathway Modules
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    continue-on-error: true  # ‚úÖ prevents ‚Äúfailure‚Äù on benign exit codes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create module issues if missing
        run: |
          set +e  # ‚úÖ allow grep to exit 1 safely
          echo "üß© Checking and creating module issues if needed..."
          for module in "Swift" "SwiftUI" "Develop in Swift"; do
            echo "üîç Checking for existing issue: $module"
            if ! gh issue list --repo codemedic1424/Develop-in-Swift-2025 --search "$module" --state all --json title | grep -q "$module"; then
              echo "‚öôÔ∏è  Creating issue for $module"
              gh issue create \
                --repo codemedic1424/Develop-in-Swift-2025 \
                --title "$module Module Tracker" \
                --body "Auto-created tracking issue for **$module** module progress." \
                --label "Module" || true  # ‚úÖ prevent CLI error from failing job
            else
              echo "‚ÑπÔ∏è  Issue already exists for $module"
            fi
          done
